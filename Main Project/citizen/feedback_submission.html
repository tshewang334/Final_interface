<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feedback Submission Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
        }

        .mobile-frame {
            width: 100%;
            max-width: 80%; /* A typical width for a mobile-friendly interface */
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, yellow, orange);
            border-radius: 20px;
            overflow: hidden;
            height: 100vh;
            margin-right: 8%;
            overflow-y: scroll;
        }
        .dropdown-container {
            position: relative;
            margin-right: 6%;
            margin-left: 6%;
        }
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            max-height: 250px;
            overflow-y: auto;
            transform-origin: top;
            animation: fadeIn 0.3s ease-out;
            margin-top: 0.5rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scaleY(0.9); }
            to { opacity: 1; transform: scaleY(1); }
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.1s;
            border-bottom: 1px solid #f3f4f6;
        }
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        /* Style for the Voice/Text selection area as seen in mockup image_e5ee58.png */
        .submission-options {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
            margin-left: 8%;
        }
        .mic-icon {
            font-size: 3rem;
        }
        .mic-icon-active {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* Custom input area styling */
        .feedback-input-box {
            min-height: 200px;
            background-color: #1f2937; /* Dark background for the text area */
            color: white;
        }
        
        /* Custom Header Styling to center logo and position user info */
        .custom-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Left (User Info), Center (Logo), Right (Empty) */
            align-items: start;
            padding: 1rem 1.5rem 0.5rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .user-greeting {
            margin-top: 200px;
            margin-bottom: 100px;
            width: 50%;
            height: 20px;
            
        }
        .logo-container {
            grid-column: 2 / 3;
            justify-self: center;
            width: 200px;
            height: 20vh;
            margin-left: 100px;
        }
        .header-right {
            grid-column: 3 / 4;
        }

        .logo{
            height: 100%;
            width: 60%;
        }
        .back{
            margin-top: 10px;
            margin-left: 10px;
            border: #f0f2f5;
        }
    </style>
    <!-- Icons from Lucide -->
</head>
<body id="app-body">
    <div id="app" class="mobile-frame">
        <div class="back-btn">
            <button onclick="goBack()" class="back">â¬…</button>
        </div>
        <!-- Header - Updated Layout -->
        <header class="custom-header">
            <!-- Left Side: User Profile & Greeting -->
            <div class="user-greeting">
                <!-- User Profile Icon -->
                <div class="w-10 h-10 rounded-full bg-yellow-200 flex items-center justify-center border border-yellow-500 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-2"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-8-8 8 8 0 0 0-8 8"/></svg>
                </div>
                <!-- Greeting Text -->
                <div>
                    <p class="text-sm font-semibold text-gray-800">Hello, User</p>
                    <p class="text-xs text-gray-500">Have a good day!</p>
                </div>
            </div>

            <!-- Center: Logo -->
            <div class="logo-container"> <!-- Added negative margin to pull it up slightly -->
                <img src="../IMAGES/government logo.png" alt="Logo" class="logo" />
            </div>
            
            <!-- Right Side: Empty space to balance the grid -->
            <div class="header-right"></div>
        </header>

        <!-- Main Content Area -->
        <main class="p-6 space-y-4">
            <!-- Dropdown 1: Ministry Department -->
            <div id="ministry-dropdown-container" class="dropdown-container">
                <button id="ministry-button" onclick="toggleDropdown('ministry')" class="w-full flex justify-between items-center px-4 py-3 bg-gray-100 rounded-lg shadow-sm text-gray-700 font-medium transition duration-150 ease-in-out hover:bg-gray-200 active:bg-gray-300">
                    <span id="ministry-label" class="text-base">Ministry Department</span>
                    <svg id="ministry-arrow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div id="ministry-list" class="dropdown-list hidden p-2">
                    <!-- Ministry items will be populated here -->
                </div>
            </div>

            <!-- Dropdown 2: Provide feedback On (Event) -->
            <div id="feedback-item-container" class="dropdown-container">
                <button id="feedback-item-button" onclick="toggleDropdown('feedback')" class="w-full flex justify-between items-center px-4 py-3 bg-gray-100 rounded-lg shadow-sm text-gray-700 font-medium transition duration-150 ease-in-out hover:bg-gray-200 active:bg-gray-300">
                    <span id="feedback-item-label" class="text-base">Provide feedback on</span>
                    <svg id="feedback-arrow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div id="feedback-item-list" class="dropdown-list hidden p-2">
                    <!-- Event items will be populated here -->
                </div>
            </div>

            <!-- Dropdown 3: Ways to Submit feedback -->
            <div id="submission-method-container" class="dropdown-container">
                <button id="submission-method-button" onclick="toggleDropdown('submission')" class="w-full flex justify-between items-center px-4 py-3 bg-gray-100 rounded-lg shadow-sm text-gray-700 font-medium transition duration-150 ease-in-out hover:bg-gray-200 active:bg-gray-300">
                    <span id="submission-method-label" class="text-base">Ways to Submit feedback</span>
                    <svg id="submission-arrow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                </button>
            </div>

            <!-- Voice/Text Selection Icons (Visible when Ways to Submit feedback is clicked) -->
            <div id="submission-options" class="submission-options hidden p-6 flex justify-around margin-left-8 items-center bg-gray-50 mt-4">
                <div onclick="selectSubmissionMethod('Voice')" class="flex flex-col items-center cursor-pointer p-4 rounded-xl transition duration-150 hover:bg-gray-200 w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    <span class="mt-2 text-sm font-medium text-gray-700">Voice</span>
                </div>
                <div onclick="selectSubmissionMethod('Text')" class="flex flex-col items-center cursor-pointer p-4 rounded-xl transition duration-150 hover:bg-gray-200 w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 3 0 0 0 2 2h4"/><line x1="10" x2="15" y1="13" y2="13"/><line x1="10" x2="15" y1="17" y2="17"/><line x1="10" x2="12" y1="9" y2="9"/></svg>
                    <span class="mt-2 text-sm font-medium text-gray-700">Text</span>
                </div>
            </div>

            <!-- Anonymous Checkbox -->
            <div class="flex items-center space-x-2 pt-4">
                <input id="anonymous-checkbox" type="checkbox" onchange="renderApp()" class="h-5 w-5 rounded text-gray-600  focus:ring-gray-500">
                <label for="anonymous-checkbox" class="text-sm  margin-left-8 text-gray-700">Submit as Anonymous</label>
            </div>

            <!-- feedback Input Area (Dynamic) -->
            <div id="feedback-input-area" class="mt-6 space-y-4 hidden">
                <div id="text-input-view" class="hidden">
                    <div class="feedback-input-box rounded-lg p-4 border border-gray-300 space-y-2 shadow-inner">
                        <div class="flex justify-between items-center text-gray-400 border-b border-gray-700 pb-2">
                            <span class="font-semibold text-sm">Type your feedback</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
                        </div>
                        <!-- Added oninput listener here to check text content -->
                        <textarea id="feedback-text-area" rows="8" oninput="renderApp()" class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none resize-none" placeholder="Start typing your anonymous feedback here..."></textarea>
                        <div class="flex justify-end pt-2 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        </div>
                    </div>
                </div>

                <div id="voice-input-view" class="hidden flex flex-col items-center justify-center p-8">
                    <p id="voice-prompt" class="text-center text-sm mb-6 text-gray-600">Press the microphone to start recording your feedback anonymously.</p>
                    
                    <!-- Recording button (Always visible, changes state) -->
                    <button id="mic-record-button" class="w-20 h-20 rounded-full bg-red-500 flex items-center justify-center shadow-lg hover:bg-red-600 transition duration-300" onclick="startVoiceRecording()">
                        <!-- Icon updated dynamically via JS -->
                        <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic-vocal"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    </button>
                    
                    <!-- Timer Display -->
                    <p id="recording-time" class="text-xl font-mono text-gray-700 mt-2 hidden">00:00</p>

                    <!-- Status message -->
                    <p id="recording-status" class="mt-4 text-red-500 font-medium hidden">Recording... Click to stop.</p>

                    <!-- Playback/Delete Controls (Hidden initially) -->
                    <div id="playback-controls" class="mt-6 flex space-x-4 hidden">
                        <button id="play-button" onclick="playRecording()" class="flex items-center space-x-2 px-4 py-2 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition duration-150" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            <span>Listen</span>
                        </button>
                        <button id="delete-button" onclick="deleteRecording()" class="flex items-center space-x-2 px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-full shadow-md hover:bg-gray-100 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            <span>Delete</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-8">
                <button id="submit-button" onclick="handleSubmit()" class="w-20 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>Submit</button>
                    
                </button>

            </div>

            <!-- Confirmation Modal -->
            <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h3 class="text-xl font-bold mb-3 text-green-600">feedback Submitted!</h3>
                    <p class="text-gray-700">Thank you for your anonymous feedback.</p>
                    <a href="four_major_sector.html" class="mt-4 w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-center inline-block">Done</a>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- State Management ---
        const state = {
            selectedMinistry: null,
            selectedfeedbackItem: null,
            selectedSubmissionMethod: null, // 'Voice', 'Text', or null
            isMinistryListOpen: false,
            isfeedbackItemListOpen: false,
            isSubmissionOptionsOpen: false,
            isRecording: false,
            hasVoiceRecording: false, // New state to track if a voice clip was recorded
            isPlaying: false, 
            recordingTime: 0, // NEW: Tracks recording time in seconds
        };

        const MINISTRIES = [
            "Ministry of Finances",
            "Ministry of Health",
            "Ministry of Home Affairs",
            "Ministry of Industry, Commerce & Employment",
            "Ministry of Infrastructure & Transport",
            "Ministry of Energy & Natural Resources",
            "Ministry of Foreign Affairs & External Trade",
            "Ministry of Education & Skill Development",
            "Ministry of Agriculture & Livestock"
        ];

        const feedback_ITEMS = [
            "Event 6 (Finance Benefits)",
            "Event 7 (Event Title)",
            "Event 8 (Event Title)",
            "Event 9 (Event Title)",
            "Event 10 (Event Title)"
        ];

        let recordingInterval = null; // Variable to hold the timer interval

        // --- DOM Elements ---
        const $ = id => document.getElementById(id);

        const ministryListEl = $('ministry-list');
        const feedbackItemListEl = $('feedback-item-list');
        const submissionOptionsEl = $('submission-options');
        const feedbackInputAreaEl = $('feedback-input-area');
        const textInputViewEl = $('text-input-view');
        const voiceInputViewEl = $('voice-input-view');
        const submitButtonEl = $('submit-button');
        const confirmationModalEl = $('confirmation-modal');
        const micRecordButtonEl = $('mic-record-button');


        // --- Utility Functions ---

        /** Formats seconds into MM:SS string. */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(remainingSeconds)}`;
        }


        /** Renders the Ministry or feedback Item list based on the provided array. */
        function renderList(type, items, selectedValue, listElement) {
            listElement.innerHTML = ''; 
            items.forEach(item => {
                const isSelected = item === selectedValue;
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                // Click handler for the whole row
                div.onclick = (e) => {
                    e.stopPropagation(); 
                    if (type === 'ministry') {
                        selectMinistry(item);
                    } else {
                        selectfeedbackItem(item);
                    }
                };
                // Clicking the checkbox now triggers the parent div's click handler and selects the item.
                div.innerHTML = `
                    <span class="${isSelected ? 'text-orange-600 font-semibold' : 'text-gray-700'}">${item}</span>
                    <input type="checkbox" ${isSelected ? 'checked' : ''} class="h-4 w-4 rounded text-orange-600 border-gray-300">
                `;
                listElement.appendChild(div);
            });
        }

        // --- Core Logic ---

        /** Toggles the custom dropdown view for a given section. */
        function toggleDropdown(section) {
            // Close all other dropdowns/options for single-open behavior
            state.isMinistryListOpen = section === 'ministry' ? !state.isMinistryListOpen : false;
            state.isfeedbackItemListOpen = section === 'feedback' ? !state.isfeedbackItemListOpen : false;
            state.isSubmissionOptionsOpen = section === 'submission' ? !state.isSubmissionOptionsOpen : false;

            // A dropdown/option click resets the final input view readiness
            if (section !== 'submission') {
                state.selectedSubmissionMethod = null;
                state.hasVoiceRecording = false;
                deleteRecording(false); // Reset voice state silently
            }

            renderApp();
        }

        /** Selects a Ministry and closes the dropdown. */
        function selectMinistry(ministry) {
            state.selectedMinistry = ministry;
            state.isMinistryListOpen = false; 
            renderApp();
        }

        /** Selects a feedback Item and closes the dropdown. */
        function selectfeedbackItem(item) {
            state.selectedfeedbackItem = item;
            state.isfeedbackItemListOpen = false; 
            renderApp();
        }

        function selectSubmissionMethod(method) {
            state.selectedSubmissionMethod = method;
            state.isSubmissionOptionsOpen = false; // Hide the Voice/Text icons after selection
            
            // Reset content states when switching method
            if (method === 'Text') {
                deleteRecording(false); // Reset voice state silently
            } else if (method === 'Voice') {
                // Reset voice state immediately
                deleteRecording(false); 
                // Clear text area when selecting voice
                $('feedback-text-area').value = ''; 
            }
            renderApp();
        }

        /** Simulates playback of the recorded voice. */
        function playRecording() {
            // Only play if recording exists, we are not already playing, and not recording
            if (state.hasVoiceRecording && !state.isPlaying && !state.isRecording) {
                state.isPlaying = true;
                const status = $('recording-status');
                status.textContent = 'Playing back recording...';
                
                // Switch status color to blue for playing
                status.classList.remove('text-red-500', 'text-green-500');
                status.classList.add('text-blue-500'); 

                // Simulate playback duration (e.g., 3 seconds)
                setTimeout(() => {
                    state.isPlaying = false;
                    // Restore status message
                    status.textContent = 'Recording finished. Ready to submit.';
                    status.classList.remove('text-blue-500');
                    status.classList.add('text-green-500');
                    renderApp();
                }, 3000); 
            }
            renderApp();
        }

        /** * Clears the recorded voice and resets the view to the idle state. 
         * @param {boolean} shouldRender - Whether to call renderApp() after deletion. Defaults to true.
         */
        function deleteRecording(shouldRender = true) {
            clearInterval(recordingInterval);
            recordingInterval = null;
            
            state.isRecording = false;
            state.hasVoiceRecording = false;
            state.isPlaying = false;
            state.recordingTime = 0; // Reset time display on delete
            
            // Reset UI elements to idle/prompt state
            const status = $('recording-status');
            status.textContent = 'Press the microphone to start recording your feedback anonymously.';
            status.classList.remove('text-green-500', 'text-red-500', 'text-blue-500');
            status.classList.add('hidden'); // Hide status on idle
            
            if (shouldRender) {
                renderApp();
            }
        }

        function startVoiceRecording() {
            const status = $('recording-status');
            
            // If we have a recording but click the mic, we assume the user wants to re-record
            if (state.hasVoiceRecording && !state.isRecording) {
                deleteRecording(false); // Silent reset
            }

            if (!state.isRecording) {
                // START recording simulation 
                state.isRecording = true;
                state.hasVoiceRecording = false; 
                state.isPlaying = false;
                state.recordingTime = 0; // Reset timer

                // Start Interval to simulate real-time recording
                recordingInterval = setInterval(() => {
                    state.recordingTime++;
                    renderApp(); 
                }, 1000);


                micRecordButtonEl.classList.add('bg-red-600', 'mic-icon-active');
                micRecordButtonEl.classList.remove('bg-red-500');

                status.textContent = 'Recording... Click to stop.';
                status.classList.remove('hidden', 'text-green-500', 'text-blue-500');
                status.classList.add('text-red-500');
            } else {
                // STOP recording simulation
                clearInterval(recordingInterval); // Stop Interval
                recordingInterval = null;

                state.isRecording = false;
                state.hasVoiceRecording = true; // Mark as having recorded content

                micRecordButtonEl.classList.remove('bg-red-600', 'mic-icon-active');
                micRecordButtonEl.classList.add('bg-red-500');

                status.textContent = 'Recording finished. Ready to submit.';
                status.classList.add('text-green-500');
                status.classList.remove('text-red-500', 'text-blue-500');
            }
            renderApp();
        }

        function handleSubmit() {
            // Check if submission is actually enabled based on logic
            if (submitButtonEl.disabled) {
                console.error("Submission failed: Not all required fields/content/anonymity check are present.");
                return;
            }
            
            // Collect final data
            const feedbackData = {
                ministry: state.selectedMinistry,
                feedbackItem: state.selectedfeedbackItem,
                method: state.selectedSubmissionMethod,
                anonymous: $('anonymous-checkbox').checked,
                content: state.selectedSubmissionMethod === 'Text' ? $('feedback-text-area').value : `Voice Recording Data (${formatTime(state.recordingTime)})`,
            };

            console.log("Submitting feedback:", feedbackData);

            // Show confirmation modal
            confirmationModalEl.classList.remove('hidden');
            confirmationModalEl.classList.add('flex');
        }
        function hideModal() {
            const modal = document.getElementById("confirmationModal");
            modal.classList.add("hidden");

    // Redirect to dashboard page after closing modal
            window.location.href = "../html/user dashboard.html";
}


        

        function resetState() {
            state.selectedMinistry = null;
            state.selectedfeedbackItem = null;
            state.selectedSubmissionMethod = null;
            state.isMinistryListOpen = false;
            state.isfeedbackItemListOpen = false;
            state.isSubmissionOptionsOpen = false;
            
            $('anonymous-checkbox').checked = false;
            $('feedback-text-area').value = '';
            
            // Reset voice state
            deleteRecording(false);
            
            // The renderApp() call inside deleteRecording() handles the final UI update
            renderApp();
        }


        /** Main render function to update the UI based on state */
        function renderApp() {
            // Get current text content for validation
            const textContent = $('feedback-text-area')?.value.trim() || '';
            const isAnonymousChecked = $('anonymous-checkbox').checked; // NEW: Anonymous check

            // Get button elements for visual feedback
            const ministryButtonEl = $('ministry-button');
            const feedbackButtonEl = $('feedback-item-button');
            const submissionButtonEl = $('submission-method-button');
            const recordingTimeEl = $('recording-time'); // NEW: Time display element


            // --- Update Ministry Dropdown ---
            const ministryLabelEl = $('ministry-label');
            const ministryArrowEl = $('ministry-arrow');
            ministryLabelEl.innerHTML = state.selectedMinistry || 'Ministry Department';
            ministryLabelEl.classList.toggle('text-orange-600', !!state.selectedMinistry);
            ministryLabelEl.classList.toggle('font-semibold', !!state.selectedMinistry);

            if (state.isMinistryListOpen) {
                ministryListEl.classList.remove('hidden');
                ministryArrowEl.style.transform = 'rotate(180deg)';
                renderList('ministry', MINISTRIES, state.selectedMinistry, ministryListEl);
                ministryButtonEl.classList.add('bg-gray-200'); 
            } else {
                ministryListEl.classList.add('hidden');
                ministryArrowEl.style.transform = 'rotate(0deg)';
                ministryButtonEl.classList.remove('bg-gray-200');
            }
            
            // --- Update feedback Item Dropdown ---
            const feedbackLabelEl = $('feedback-item-label');
            const feedbackArrowEl = $('feedback-arrow');
            feedbackLabelEl.innerHTML = state.selectedfeedbackItem || 'Provide feedback on';
            feedbackLabelEl.classList.toggle('text-orange-600', !!state.selectedfeedbackItem);
            feedbackLabelEl.classList.toggle('font-semibold', !!state.selectedfeedbackItem);

            if (state.isfeedbackItemListOpen) {
                feedbackItemListEl.classList.remove('hidden');
                feedbackArrowEl.style.transform = 'rotate(180deg)';
                renderList('feedback', feedback_ITEMS, state.selectedfeedbackItem, feedbackItemListEl);
                feedbackButtonEl.classList.add('bg-gray-200');
            } else {
                feedbackItemListEl.classList.add('hidden');
                feedbackArrowEl.style.transform = 'rotate(0deg)';
                feedbackButtonEl.classList.remove('bg-gray-200');
            }

            // --- Update Submission Options (Inline) ---
            const submissionLabelEl = $('submission-method-label');
            const submissionArrowEl = $('submission-arrow');

            if (state.selectedSubmissionMethod) {
                submissionLabelEl.innerHTML = `Submission via: <span class="text-orange-600 font-semibold">${state.selectedSubmissionMethod}</span>`;
            } else {
                submissionLabelEl.innerHTML = 'Ways to Submit feedback';
                submissionLabelEl.classList.remove('text-orange-600', 'font-semibold');
            }

            if (state.isSubmissionOptionsOpen) {
                submissionOptionsEl.classList.remove('hidden');
                submissionArrowEl.style.transform = 'rotate(180deg)';
                feedbackInputAreaEl.classList.add('hidden');
                submissionButtonEl.classList.add('bg-gray-200');
            } else {
                submissionOptionsEl.classList.add('hidden');
                submissionArrowEl.style.transform = 'rotate(0deg)';
                submissionButtonEl.classList.remove('bg-gray-200');
            }

            // --- Update Final feedback Input Area ---
            if (state.selectedSubmissionMethod && !state.isSubmissionOptionsOpen) {
                feedbackInputAreaEl.classList.remove('hidden');

                if (state.selectedSubmissionMethod === 'Text') {
                    textInputViewEl.classList.remove('hidden');
                    voiceInputViewEl.classList.add('hidden');
                } else if (state.selectedSubmissionMethod === 'Voice') {
                    voiceInputViewEl.classList.remove('hidden');
                    textInputViewEl.classList.add('hidden');
                    
                    const voicePromptEl = $('voice-prompt');
                    const playbackControlsEl = $('playback-controls');
                    const micIconEl = $('mic-icon');
                    const playButtonEl = $('play-button');
                    
                    // NEW: Update time display and visibility
                    recordingTimeEl.textContent = formatTime(state.recordingTime);

                    // --- Voice Recording State Logic ---
                    
                    if (state.isRecording) {
                        // STATE: RECORDING
                        micRecordButtonEl.classList.add('mic-icon-active');
                        micRecordButtonEl.classList.add('bg-red-600');
                        micRecordButtonEl.classList.remove('bg-red-500');
                        
                        micIconEl.innerHTML = `<path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/>`; // Mic icon
                        
                        voicePromptEl.classList.add('hidden');
                        playbackControlsEl.classList.add('hidden');
                        recordingTimeEl.classList.remove('hidden'); // Show time
                        recordingTimeEl.classList.remove('text-gray-500');
                        recordingTimeEl.classList.add('text-red-500');

                    } else if (state.hasVoiceRecording) {
                        // STATE: RECORDING STOPPED / READY FOR SUBMISSION / PLAYING
                        micRecordButtonEl.classList.remove('mic-icon-active');
                        micRecordButtonEl.classList.remove('bg-red-600');
                        micRecordButtonEl.classList.add('bg-red-500');
                        
                        voicePromptEl.classList.add('hidden');
                        playbackControlsEl.classList.remove('hidden');
                        recordingTimeEl.classList.remove('hidden'); // Show time
                        recordingTimeEl.classList.remove('text-red-500');
                        recordingTimeEl.classList.add('text-gray-700'); // Change color when stopped
                        
                        // Change mic button icon to playback symbol 
                        micIconEl.innerHTML = `<polygon points="5 3 19 12 5 21 5 3"/>`; // Play Icon

                        if (state.isPlaying) {
                             // STATE: PLAYING
                            micRecordButtonEl.classList.add('bg-gray-400'); // Gray out mic button while playing
                            micRecordButtonEl.disabled = true;
                            micIconEl.innerHTML = `<path d="M14.5 9a3 3 0 0 0-5.22 0"/><path d="M16 11.3a7 7 0 0 0-8 0"/><path d="M17.5 13.6a10 10 0 0 0-11 0"/><circle cx="12" cy="12" r="10"/>`; // Audio Wave Icon
                            playButtonEl.disabled = true;
                            playButtonEl.textContent = 'Playing...';
                            
                            const status = $('recording-status');
                            status.classList.remove('text-green-500', 'text-red-500');
                            status.classList.add('text-blue-500');

                        } else {
                            // STATE: STOPPED / READY FOR SUBMISSION
                            micRecordButtonEl.classList.remove('bg-gray-400');
                            micRecordButtonEl.disabled = false;
                            playButtonEl.disabled = false;
                            playButtonEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg><span>Listen</span>`;
                        }

                    } else {
                        // STATE: IDLE (NO RECORDING)
                        micRecordButtonEl.classList.remove('mic-icon-active', 'bg-red-600', 'bg-gray-400');
                        micRecordButtonEl.classList.add('bg-red-500');
                        micRecordButtonEl.disabled = false;
                        
                        micIconEl.innerHTML = `<path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/>`; // Mic icon
                        
                        voicePromptEl.classList.remove('hidden');
                        playbackControlsEl.classList.add('hidden');
                        $('recording-status').classList.add('hidden'); // Hide status on idle
                        recordingTimeEl.classList.add('hidden'); // Hide time
                    }

                }
            } else {
                feedbackInputAreaEl.classList.add('hidden');
            }

            // --- Submission Validation Logic ---
            let isContentReady = false;

            if (state.selectedSubmissionMethod === 'Text') {
                // Content is ready only if text area is not empty
                isContentReady = textContent.length > 0;
            } else if (state.selectedSubmissionMethod === 'Voice') {
                // Content is ready only if recording is STOPPED, captured, AND NOT currently playing
                isContentReady = !state.isRecording && state.hasVoiceRecording && !state.isPlaying;
            }

            const isFormComplete = !!state.selectedMinistry && 
                                   !!state.selectedfeedbackItem && 
                                   !!state.selectedSubmissionMethod;

            // UPDATED: Must be form complete, content ready, AND Anonymous checkbox must be checked
            const readyToSubmit = isFormComplete && isContentReady && isAnonymousChecked;
            
            submitButtonEl.disabled = !readyToSubmit;
            
            // Set submit button colors
            submitButtonEl.classList.toggle('bg-orange-500', readyToSubmit);
            submitButtonEl.classList.toggle('hover:bg-orange-600', readyToSubmit);
            submitButtonEl.classList.toggle('bg-gray-500', !readyToSubmit);
            submitButtonEl.classList.toggle('hover:bg-gray-600', !readyToSubmit);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', renderApp);

        // Close all dropdowns if user clicks outside
        document.addEventListener('click', (event) => {
            const isInsideDropdown = event.target.closest('.dropdown-container');
            const isInsideSubmissionOptions = event.target.closest('#submission-options');
            
            // Check if the click was on the submit button itself or the anonymous checkbox
            const isSubmitRelated = event.target.closest('#submit-button') || event.target.closest('#anonymous-checkbox');

            if (!isInsideDropdown && !isInsideSubmissionOptions && !isSubmitRelated) {
                let shouldRender = false;
                if (state.isMinistryListOpen || state.isfeedbackItemListOpen || state.isSubmissionOptionsOpen) {
                    shouldRender = true;
                }
                state.isMinistryListOpen = false;
                state.isfeedbackItemListOpen = false;
                state.isSubmissionOptionsOpen = false;
                if (shouldRender) {
                    renderApp();
                }
            }
        });
        function goBack(){
            window.location.href = "four_major_sector.html"
        }
    </script>
</body>
</html>
